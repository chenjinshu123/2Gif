!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Gif=e()}(this,(function(){"use strict";function t(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function e(e){for(var i=1;i<arguments.length;i++){var r=null!=arguments[i]?arguments[i]:{};i%2?t(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function o(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function a(t){return a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},a(t)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}function h(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function l(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,r=a(t);if(e){var n=a(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return h(this,i)}}var u=function(){function t(){i(this,t),this.eventObj={}}return n(t,[{key:"on",value:function(t,e){this.eventObj[t]||(this.eventObj[t]=[]),this.eventObj[t].push(e)}},{key:"emit",value:function(t){for(var e=this,i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];this.eventObj[t]&&this.eventObj[t].forEach((function(t,i){if("function"!=typeof t)throw Errow(t+"not a function!");t.apply(e,r)}))}}]),t}(),c=256,f=1024,p=1<<18;function d(t,e){var i,r,n,o,a;function s(t,e,r,n,o){i[e][0]-=t*(i[e][0]-r)/f,i[e][1]-=t*(i[e][1]-n)/f,i[e][2]-=t*(i[e][2]-o)/f}function h(t,e,r,n,o){for(var s,h,l=Math.abs(e-t),u=Math.min(e+t,c),f=e+1,d=e-1,y=1;f<u||d>l;)h=a[y++],f<u&&((s=i[f++])[0]-=h*(s[0]-r)/p,s[1]-=h*(s[1]-n)/p,s[2]-=h*(s[2]-o)/p),d>l&&((s=i[d--])[0]-=h*(s[0]-r)/p,s[1]-=h*(s[1]-n)/p,s[2]-=h*(s[2]-o)/p)}function l(t,e,r){var a,s,h,l,u,f=~(1<<31),p=f,d=-1,y=d;for(a=0;a<c;a++)s=i[a],(h=Math.abs(s[0]-t)+Math.abs(s[1]-e)+Math.abs(s[2]-r))<f&&(f=h,d=a),(l=h-(n[a]>>12))<p&&(p=l,y=a),u=o[a]>>10,o[a]-=u,n[a]+=u<<10;return o[d]+=64,n[d]-=65536,y}this.buildColormap=function(){!function(){var t,e;for(i=[],r=new Int32Array(256),n=new Int32Array(c),o=new Int32Array(c),a=new Int32Array(32),t=0;t<c;t++)e=(t<<12)/c,i[t]=new Float64Array([e,e,e,0]),o[t]=256,n[t]=0}(),function(){var i,r,n,o,u,c,p=t.length,d=30+(e-1)/3,y=p/(3*e),g=~~(y/100),w=f,v=2048,b=v>>6;for(b<=1&&(b=0),i=0;i<b;i++)a[i]=w*(256*(b*b-i*i)/(b*b));p<1509?(e=1,r=3):r=p%499!=0?1497:p%491!=0?1473:p%487!=0?1461:1509;var m=0;for(i=0;i<y;)if(s(w,c=l(n=(255&t[m])<<4,o=(255&t[m+1])<<4,u=(255&t[m+2])<<4),n,o,u),0!==b&&h(b,c,n,o,u),(m+=r)>=p&&(m-=p),0===g&&(g=1),++i%g==0)for(w-=w/d,(b=(v-=v/30)>>6)<=1&&(b=0),c=0;c<b;c++)a[c]=w*(256*(b*b-c*c)/(b*b))}(),function(){for(var t=0;t<c;t++)i[t][0]>>=4,i[t][1]>>=4,i[t][2]>>=4,i[t][3]=t}(),function(){var t,e,n,o,a,s,h=0,l=0;for(t=0;t<c;t++){for(a=t,s=(n=i[t])[1],e=t+1;e<c;e++)(o=i[e])[1]<s&&(a=e,s=o[1]);if(o=i[a],t!=a&&(e=o[0],o[0]=n[0],n[0]=e,e=o[1],o[1]=n[1],n[1]=e,e=o[2],o[2]=n[2],n[2]=e,e=o[3],o[3]=n[3],n[3]=e),s!=h){for(r[h]=l+t>>1,e=h+1;e<s;e++)r[e]=t;h=s,l=t}}for(r[h]=l+255>>1,e=h+1;e<256;e++)r[e]=255}()},this.getColormap=function(){for(var t=[],e=[],r=0;r<c;r++)e[i[r][3]]=r;for(var n=0,o=0;o<c;o++){var a=e[o];t[n++]=i[a][0],t[n++]=i[a][1],t[n++]=i[a][2]}return t},this.lookupRGB=function(t,e,n){for(var o,a,s,h=1e3,l=-1,u=r[e],f=u-1;u<c||f>=0;)u<c&&((s=(a=i[u])[1]-e)>=h?u=c:(u++,s<0&&(s=-s),(o=a[0]-t)<0&&(o=-o),(s+=o)<h&&((o=a[2]-n)<0&&(o=-o),(s+=o)<h&&(h=s,l=a[3])))),f>=0&&((s=e-(a=i[f])[1])>=h?f=-1:(f--,s<0&&(s=-s),(o=a[0]-t)<0&&(o=-o),(s+=o)<h&&((o=a[2]-n)<0&&(o=-o),(s+=o)<h&&(h=s,l=a[3]))));return l}}var y=5003,g=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function w(t,e,i,r){var n,o,a,s,h,l,u,c,f,p=Math.max(2,r),d=new Uint8Array(256),w=new Int32Array(y),v=new Int32Array(y),b=0,m=0,x=!1;function P(t,e){d[o++]=t,o>=254&&S(e)}function B(t){O(y),m=c+2,x=!0,C(c,t)}function O(t){for(var e=0;e<t;++e)w[e]=-1}function S(t){o>0&&(t.writeByte(o),t.writeBytes(d,0,o),o=0)}function E(t){return(1<<t)-1}function j(){return 0===s?-1:(--s,255&i[h++])}function C(t,e){for(n&=g[b],b>0?n|=t<<b:n=t,b+=l;b>=8;)P(255&n,e),n>>=8,b-=8;if((m>a||x)&&(x?(a=E(l=u),x=!1):(++l,a=12==l?4096:E(l))),t==f){for(;b>0;)P(255&n,e),n>>=8,b-=8;S(e)}}this.encode=function(i){i.writeByte(p),s=t*e,h=0,function(t,e){var i,r,n,s,h,p,d;for(x=!1,a=E(l=u=t),f=1+(c=1<<t-1),m=c+2,o=0,s=j(),d=0,i=y;i<65536;i*=2)++d;d=8-d,O(p=y),C(c,e);t:for(;-1!=(r=j());)if(i=(r<<12)+s,w[n=r<<d^s]!==i){if(w[n]>=0){h=p-n,0===n&&(h=1);do{if((n-=h)<0&&(n+=p),w[n]===i){s=v[n];continue t}}while(w[n]>=0)}C(s,e),s=r,m<4096?(v[n]=m++,w[n]=i):B(e)}else s=v[n];C(s,e),C(f,e)}(p+1,i),i.writeByte(0)}}function v(){this.page=-1,this.pages=[],this.newPage()}v.pageSize=4096,v.charMap={};for(var b=0;b<256;b++)v.charMap[b]=String.fromCharCode(b);function m(t,e){this.width=~~t,this.height=~~e,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.neuQuant=null,this.usedEntry=new Array,this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.dither=!1,this.globalPalette=!1,this.out=new v}v.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(v.pageSize),this.cursor=0},v.prototype.getData=function(){for(var t="",e=0;e<this.pages.length;e++)for(var i=0;i<v.pageSize;i++)t+=v.charMap[this.pages[e][i]];return t},v.prototype.writeByte=function(t){this.cursor>=v.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=t},v.prototype.writeUTFBytes=function(t){for(var e=t.length,i=0;i<e;i++)this.writeByte(t.charCodeAt(i))},v.prototype.writeBytes=function(t,e,i){for(var r=i||t.length,n=e||0;n<r;n++)this.writeByte(t[n])},m.prototype.setDelay=function(t){this.delay=Math.round(t/10)},m.prototype.setFrameRate=function(t){this.delay=Math.round(100/t)},m.prototype.setDispose=function(t){t>=0&&(this.dispose=t)},m.prototype.setRepeat=function(t){this.repeat=t},m.prototype.setTransparent=function(t){this.transparent=t},m.prototype.addFrame=function(t){this.image=t,this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null,this.getImagePixels(),this.analyzePixels(),!0===this.globalPalette&&(this.globalPalette=this.colorTab),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.globalPalette||this.writePalette(),this.writePixels(),this.firstFrame=!1},m.prototype.finish=function(){this.out.writeByte(59)},m.prototype.setQuality=function(t){t<1&&(t=1),this.sample=t},m.prototype.setDither=function(t){!0===t&&(t="FloydSteinberg"),this.dither=t},m.prototype.setGlobalPalette=function(t){this.globalPalette=t},m.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette},m.prototype.writeHeader=function(){this.out.writeUTFBytes("GIF89a")},m.prototype.analyzePixels=function(){this.colorTab||(this.neuQuant=new d(this.pixels,this.sample),this.neuQuant.buildColormap(),this.colorTab=this.neuQuant.getColormap()),this.dither?this.ditherPixels(this.dither.replace("-serpentine",""),null!==this.dither.match(/-serpentine/)):this.indexPixels(),this.pixels=null,this.colorDepth=8,this.palSize=7,null!==this.transparent&&(this.transIndex=this.findClosest(this.transparent,!0))},m.prototype.indexPixels=function(t){var e=this.pixels.length/3;this.indexedPixels=new Uint8Array(e);for(var i=0,r=0;r<e;r++){var n=this.findClosestRGB(255&this.pixels[i++],255&this.pixels[i++],255&this.pixels[i++]);this.usedEntry[n]=!0,this.indexedPixels[r]=n}},m.prototype.ditherPixels=function(t,e){var i={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]};if(!t||!i[t])throw"Unknown dithering kernel: "+t;var r=i[t],n=0,o=this.height,a=this.width,s=this.pixels,h=e?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(var l=0;l<o;l++){e&&(h*=-1);for(var u=1==h?0:a-1,c=1==h?a:0;u!==c;u+=h){var f=3*(n=l*a+u),p=s[f],d=s[f+1],y=s[f+2];f=this.findClosestRGB(p,d,y),this.usedEntry[f]=!0,this.indexedPixels[n]=f,f*=3;for(var g=p-this.colorTab[f],w=d-this.colorTab[f+1],v=y-this.colorTab[f+2],b=1==h?0:r.length-1,m=1==h?r.length:0;b!==m;b+=h){var x=r[b][1],P=r[b][2];if(x+u>=0&&x+u<a&&P+l>=0&&P+l<o){var B=r[b][0];f=n+x+P*a,s[f*=3]=Math.max(0,Math.min(255,s[f]+g*B)),s[f+1]=Math.max(0,Math.min(255,s[f+1]+w*B)),s[f+2]=Math.max(0,Math.min(255,s[f+2]+v*B))}}}}},m.prototype.findClosest=function(t,e){return this.findClosestRGB((16711680&t)>>16,(65280&t)>>8,255&t,e)},m.prototype.findClosestRGB=function(t,e,i,r){if(null===this.colorTab)return-1;if(this.neuQuant&&!r)return this.neuQuant.lookupRGB(t,e,i);for(var n=0,o=16777216,a=this.colorTab.length,s=0,h=0;s<a;h++){var l=t-(255&this.colorTab[s++]),u=e-(255&this.colorTab[s++]),c=i-(255&this.colorTab[s++]),f=l*l+u*u+c*c;(!r||this.usedEntry[h])&&f<o&&(o=f,n=h)}return n},m.prototype.getImagePixels=function(){var t=this.width,e=this.height;this.pixels=new Uint8Array(t*e*3);for(var i=this.image,r=0,n=0,o=0;o<e;o++)for(var a=0;a<t;a++)this.pixels[n++]=i[r++],this.pixels[n++]=i[r++],this.pixels[n++]=i[r++],r++},m.prototype.writeGraphicCtrlExt=function(){var t,e;this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4),null===this.transparent?(t=0,e=0):(t=1,e=2),this.dispose>=0&&(e=7&this.dispose),e<<=2,this.out.writeByte(0|e|t),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},m.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame||this.globalPalette?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},m.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},m.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},m.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);for(var t=768-this.colorTab.length,e=0;e<t;e++)this.out.writeByte(0)},m.prototype.writeShort=function(t){this.out.writeByte(255&t),this.out.writeByte(t>>8&255)},m.prototype.writePixels=function(){new w(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)},m.prototype.stream=function(){return this.out};var x=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&s(t,e)}(o,t);var r=l(o);function o(t){var n;i(this,o),n=r.call(this);var a={dither:!1,repeat:0,transparent:null,background:void 0};return["quality","width","height","delay"].forEach((function(e){if(!t[e])throw"Missing parameter ".concat(e)})),n.running=!1,n._canvas=null,n.options=e(e({quality:10,width:void 0,height:void 0},t),a),n.frameArr=[],n.okFrame=[],n}return n(o,[{key:"addFrame",value:function(t){var e={delay:this.options.delay,copy:!1,dispose:-1};if(ImageData&&t instanceof ImageData)e.data=t.data;else if(CanvasRenderingContext2D&&t instanceof CanvasRenderingContext2D||WebGLRenderingContext&&t instanceof WebGLRenderingContext)e.context=t;else{if(!t.childNodes)throw new Error("Invalid image");e.image=t}this.frameArr.push(e)}},{key:"getContextData",value:function(t){return t.getImageData(0,0,this.options.width,this.options.height).data}},{key:"getImageData",value:function(t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height);var e=this._canvas.getContext("2d");return e.fillStyle=this.options.background,e.fillRect(0,0,this.options.width,this.options.height),e.drawImage(t,0,0),console.log(t),this.getContextData(e)}},{key:"getTask",value:function(t,e){var i={index:e,last:e===this.frameArr.length-1,delay:this.options.delay,dispose:t.dispose,transparent:t.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat};if(t.data)i.data=t.data;else if(t.context)i.data=this.getContextData(t.context);else{if(!t.image)throw new Error("Invalid frame");i.data=this.getImageData(t.image)}return i}},{key:"render",value:function(){var t=this;if(this.running)throw new Error("Already running");this.frameArr.forEach((function(e,i){var r=t.getTask(e,i),n=t.renderFrame(r);t.okFrame.push(n),t.okFrame.length===t.frameArr.length&&t.finishRendering()}))}},{key:"finishRendering",value:function(){var t=0;this.okFrame.forEach((function(e){t+=(e.data.length-1)*e.pageSize+e.cursor,t+=e.pageSize-e.cursor}));var e=new Uint8Array(t),i=0;this.okFrame.forEach((function(t){t.data.forEach((function(r,n){e.set(r,i),n===t.data.length-1?i+=t.cursor:i+=t.pageSize}))})),console.log(e);var r=new Blob([e],{type:"image/gif"}),n=document.createElement("a");n.href=URL.createObjectURL(r),n.download="demo-name",document.body.appendChild(n);var o=document.createEvent("MouseEvents");o.initEvent("click",!1,!1),n.dispatchEvent(o),document.body.removeChild(n)}},{key:"renderFrame",value:function(t){var e=new m(t.width,t.height);0===t.index?e.writeHeader():e.firstFrame=!1,e.setTransparent(t.transparent),e.setDispose(t.dispose),e.setRepeat(t.repeat),e.setDelay(t.delay),e.setQuality(t.quality),e.setDither(t.dither),e.setGlobalPalette(t.globalPalette),e.addFrame(t.data),t.last&&e.finish();var i=e.stream();return t.data=i.pages,t.cursor=i.cursor,t.pageSize=i.constructor.pageSize,t}}]),o}(u);return x}));
//# sourceMappingURL=gif.js.map
